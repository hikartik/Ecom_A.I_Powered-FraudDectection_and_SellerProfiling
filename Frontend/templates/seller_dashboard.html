<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Seller Dashboard - Amazon Clone</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css"
    />
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: "Amazon Ember", Arial, sans-serif;
      }

      body {
        background-color: #f8f9fa;
      }

      /* Header Styles */
      .header {
        background: linear-gradient(to right, #232f3e, #131921);
        color: white;
        padding: 15px 0;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      }

      .header-content {
        max-width: 1200px;
        margin: 0 auto;
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0 20px;
      }

      .logo {
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .logo img {
        width: 100px;
        height: auto;
      }

      .logo h1 {
        font-size: 24px;
        font-weight: 500;
      }

      .user-menu {
        display: flex;
        align-items: center;
        gap: 20px;
      }

      .user-info {
        text-align: right;
      }

      .user-name {
        font-size: 16px;
        font-weight: 500;
      }

      .user-type {
        font-size: 12px;
        color: #ccc;
      }

      .logout-btn {
        background: #dc3545;
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
        transition: background-color 0.3s;
      }

      .logout-btn:hover {
        background: #c82333;
      }

      /* Dashboard Container */
      .dashboard-container {
        max-width: 1200px;
        margin: 20px auto;
        padding: 0 20px;
      }

      /* Stats Cards */
      .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
      }

      .stat-card {
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        text-align: center;
      }

      .stat-card i {
        font-size: 2.5em;
        margin-bottom: 10px;
        color: #232f3e;
      }

      .stat-number {
        font-size: 2em;
        font-weight: bold;
        color: #232f3e;
        margin-bottom: 5px;
      }

      .stat-label {
        color: #666;
        font-size: 14px;
      }

      /* Filters Section */
      .filters-section {
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
      }

      .filters-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        align-items: end;
      }

      .filter-group {
        display: flex;
        flex-direction: column;
      }

      .filter-group label {
        margin-bottom: 5px;
        font-weight: 500;
        color: #333;
      }

      .filter-group input,
      .filter-group select {
        padding: 8px 12px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 14px;
      }

      .filter-group input:focus,
      .filter-group select:focus {
        outline: none;
        border-color: #e77600;
        box-shadow: 0 0 3px 2px rgba(228, 121, 17, 0.5);
      }

      .filter-buttons {
        display: flex;
        gap: 10px;
      }

      .btn {
        padding: 8px 16px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
        transition: all 0.3s;
      }

      .btn-primary {
        background: #f0c14b;
        color: #111;
      }

      .btn-primary:hover {
        background: #ddb347;
      }

      .btn-secondary {
        background: #6c757d;
        color: white;
      }

      .btn-secondary:hover {
        background: #5a6268;
      }

      /* Products Table */
      .products-section {
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        overflow: hidden;
      }

      .section-header {
        padding: 20px;
        border-bottom: 1px solid #eee;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .section-title {
        font-size: 20px;
        font-weight: 500;
        color: #333;
      }

      .product-count {
        color: #666;
        font-size: 14px;
      }

      .table-container {
        overflow-x: auto;
      }

      .products-table {
        width: 100%;
        border-collapse: collapse;
      }

      .products-table th,
      .products-table td {
        padding: 12px 15px;
        text-align: left;
        border-bottom: 1px solid #eee;
      }

      .products-table th {
        background-color: #f8f9fa;
        font-weight: 600;
        color: #333;
        font-size: 14px;
      }

      .products-table tr:hover {
        background-color: #f8f9fa;
      }

      .product-image {
        width: 60px;
        height: 60px;
        object-fit: cover;
        border-radius: 4px;
      }

      .ai-score {
        display: inline-block;
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 500;
      }

      .ai-score.high {
        background: #d4edda;
        color: #155724;
      }

      .ai-score.medium {
        background: #fff3cd;
        color: #856404;
      }

      .ai-score.low {
        background: #f8d7da;
        color: #721c24;
      }

      .status {
        display: inline-block;
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 500;
        text-transform: capitalize;
      }

      .status.valid {
        background: #d4edda;
        color: #155724;
      }

      .status.blocked {
        background: #f8d7da;
        color: #721c24;
      }

      .status.pending {
        background: #fff3cd;
        color: #856404;
      }

      .action-btn {
        padding: 6px 12px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 12px;
        margin-right: 5px;
        transition: all 0.3s;
      }

      .action-btn.edit {
        background: #007bff;
        color: white;
      }

      .action-btn.edit:hover {
        background: #0056b3;
      }

      .action-btn.delete {
        background: #dc3545;
        color: white;
      }

      .action-btn.delete:hover {
        background: #c82333;
      }

      .action-btn.view {
        background: #28a745;
        color: white;
      }

      .action-btn.view:hover {
        background: #1e7e34;
      }

      /* Loading and Empty States */
      .loading {
        text-align: center;
        padding: 40px;
        color: #666;
      }

      .empty-state {
        text-align: center;
        padding: 40px;
        color: #666;
      }

      .empty-state i {
        font-size: 3em;
        margin-bottom: 20px;
        color: #ddd;
      }

      /* Responsive Design */
      @media (max-width: 768px) {
        .header-content {
          flex-direction: column;
          gap: 15px;
        }

        .stats-grid {
          grid-template-columns: 1fr;
        }

        .filters-grid {
          grid-template-columns: 1fr;
        }

        .filter-buttons {
          justify-content: center;
        }

        .products-table {
          font-size: 12px;
        }

        .products-table th,
        .products-table td {
          padding: 8px 10px;
        }
      }

      /* Modal Styles */
      .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
      }

      .modal-content {
        background-color: white;
        margin: 2% auto;
        padding: 30px;
        border-radius: 8px;
        width: 90%;
        max-width: 500px;
        max-height: 90vh;
        overflow-y: auto;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        position: relative;
      }

      .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 1px solid #eee;
      }

      .modal-title {
        font-size: 20px;
        font-weight: 500;
        color: #333;
      }

      .close {
        color: #aaa;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
        line-height: 1;
      }

      .close:hover {
        color: #000;
      }

      .modal-form {
        display: flex;
        flex-direction: column;
        gap: 20px;
      }

      .form-group {
        display: flex;
        flex-direction: column;
      }

      .form-group label {
        margin-bottom: 8px;
        font-weight: 500;
        color: #333;
        font-size: 14px;
      }

      .form-group input,
      .form-group textarea {
        padding: 12px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 14px;
        font-family: inherit;
      }

      .form-group input:focus,
      .form-group textarea:focus {
        outline: none;
        border-color: #e77600;
        box-shadow: 0 0 3px 2px rgba(228, 121, 17, 0.5);
      }

      .form-group textarea {
        resize: vertical;
        min-height: 100px;
      }

      .image-upload {
        border: 2px dashed #ddd;
        border-radius: 4px;
        padding: 20px;
        text-align: center;
        cursor: pointer;
        transition: border-color 0.3s;
      }

      .image-upload:hover {
        border-color: #e77600;
      }

      .image-upload.dragover {
        border-color: #e77600;
        background-color: #fff8f0;
      }

      .image-preview {
        max-width: 200px;
        max-height: 200px;
        margin-top: 10px;
        border-radius: 4px;
        display: none;
      }

      .modal-buttons {
        display: flex;
        gap: 10px;
        justify-content: flex-end;
        margin-top: 20px;
        padding-top: 20px;
        border-top: 1px solid #eee;
      }

      .btn-cancel {
        background: #6c757d;
        color: white;
      }

      .btn-cancel:hover {
        background: #5a6268;
      }

      .btn-save {
        background: #28a745;
        color: white;
      }

      .btn-save:hover {
        background: #1e7e34;
      }

      .btn-save:disabled {
        background: #6c757d;
        cursor: not-allowed;
      }
    </style>
  </head>
  <body>
    <!-- Header -->
    <header class="header">
      <div class="header-content">
        <div class="logo">
          <img src="../assets/amazon_logo.png" alt="Amazon" />
          <h1>Seller Dashboard</h1>
        </div>
        <div class="user-menu">
          <div class="user-info">
            <div class="user-name" id="userName">Loading...</div>
            <div class="user-type">Seller</div>
          </div>
          <button class="logout-btn" onclick="logout()">
            <i class="fas fa-sign-out-alt"></i> Logout
          </button>
        </div>
      </div>
    </header>

    <!-- Dashboard Container -->
    <div class="dashboard-container">
      <!-- Stats Cards -->
      <div class="stats-grid">
        <div class="stat-card">
          <i class="fas fa-box"></i>
          <div class="stat-number" id="totalProducts">0</div>
          <div class="stat-label">Total Products</div>
        </div>
        <div class="stat-card">
          <i class="fas fa-star"></i>
          <div class="stat-number" id="avgRating">0.0</div>
          <div class="stat-label">Average Rating</div>
        </div>
        <div class="stat-card">
          <i class="fas fa-robot"></i>
          <div class="stat-number" id="avgAiScore">0%</div>
          <div class="stat-label">Average AI Score</div>
        </div>
        <div class="stat-card">
          <i class="fas fa-check-circle"></i>
          <div class="stat-number" id="validProducts">0</div>
          <div class="stat-label">Valid Products</div>
        </div>
      </div>

      <!-- Filters Section -->
      <div class="filters-section">
        <div class="filters-grid">
          <div class="filter-group">
            <label for="searchFilter">Search Products</label>
            <input
              type="text"
              id="searchFilter"
              placeholder="Search by name, ID, or description..."
            />
          </div>
          <div class="filter-group">
            <label for="statusFilter">Status</label>
            <select id="statusFilter">
              <option value="">All Status</option>
              <option value="valid">Valid</option>
              <option value="blocked">Blocked</option>
              <option value="pending">Pending</option>
            </select>
          </div>
          <div class="filter-group">
            <label for="aiScoreFilter">AI Score</label>
            <select id="aiScoreFilter">
              <option value="">All Scores</option>
              <option value="high">High (80%+)</option>
              <option value="medium">Medium (60-79%)</option>
              <option value="low">Low (<60%)</option>
            </select>
          </div>
          <div class="filter-group">
            <label for="sortBy">Sort By</label>
            <select id="sortBy">
              <option value="name">Name</option>
              <option value="ai_score">AI Score</option>
              <option value="rating">Rating</option>
              <option value="price">Price</option>
              <option value="date">Date Added</option>
            </select>
          </div>
          <div class="filter-buttons">
            <button class="btn btn-primary" onclick="applyFilters()">
              <i class="fas fa-filter"></i> Apply Filters
            </button>
            <button class="btn btn-secondary" onclick="clearFilters()">
              <i class="fas fa-times"></i> Clear
            </button>
          </div>
        </div>
      </div>

      <!-- Products Section -->
      <div class="products-section">
        <div class="section-header">
          <div>
            <h2 class="section-title">Your Products</h2>
            <div class="product-count" id="productCount">0 products found</div>
          </div>
          <button class="btn btn-primary" onclick="addNewProduct()">
            <i class="fas fa-plus"></i> Add New Product
          </button>
        </div>

        <div class="table-container">
          <table class="products-table">
            <thead>
              <tr>
                <th>Image</th>
                <th>Product ID</th>
                <th>Name</th>
                <th>Description</th>
                <th>Price</th>
                <th>AI Score</th>
                <th>Rating</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="productsTableBody">
              <tr>
                <td colspan="9" class="loading">
                  <i class="fas fa-spinner fa-spin"></i> Loading products...
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Add Product Modal -->
    <div id="addProductModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2 class="modal-title">Add New Product</h2>
          <span class="close" onclick="closeModal()">&times;</span>
        </div>
        <form class="modal-form" id="addProductForm">
          <div class="form-group">
            <label for="productName">Product Name *</label>
            <input
              type="text"
              id="productName"
              name="productName"
              required
              placeholder="Enter product name"
            />
          </div>

          <div class="form-group">
            <label for="productDescription">Description *</label>
            <textarea
              id="productDescription"
              name="productDescription"
              required
              placeholder="Enter product description"
            ></textarea>
          </div>

          <div class="form-group">
            <label for="productPrice">Price (₹) *</label>
            <input
              type="number"
              id="productPrice"
              name="productPrice"
              required
              placeholder="Enter product price"
              min="0"
              step="0.01"
            />
          </div>

          <div class="form-group">
            <label for="productImage">Product Image</label>
            <div
              class="image-upload"
              onclick="document.getElementById('imageFile').click()"
            >
              <i
                class="fas fa-cloud-upload-alt"
                style="font-size: 2em; color: #ccc; margin-bottom: 10px"
              ></i>
              <p>Click to upload image or drag and drop</p>
              <p style="font-size: 12px; color: #666">
                Supports: JPG, PNG, GIF (Max 5MB)
              </p>
              <input
                type="file"
                id="imageFile"
                accept="image/*"
                style="display: none"
                onchange="handleImageUpload(event)"
              />
            </div>
            <img id="imagePreview" class="image-preview" alt="Preview" />
          </div>
        </form>

        <div class="modal-buttons">
          <button type="button" class="btn btn-cancel" onclick="closeModal()">
            Cancel
          </button>
          <button
            type="button"
            class="btn btn-save"
            onclick="saveProduct()"
            id="saveBtn"
          >
            Save Product
          </button>
        </div>
      </div>
    </div>

    <!-- Edit Product Modal -->
    <div id="editProductModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2 class="modal-title">Edit Product</h2>
          <span class="close" onclick="closeEditModal()">&times;</span>
        </div>
        <form class="modal-form" id="editProductForm">
          <input type="hidden" id="editProductId" name="editProductId" />

          <div class="form-group">
            <label for="editProductName">Product Name *</label>
            <input
              type="text"
              id="editProductName"
              name="editProductName"
              required
              placeholder="Enter product name"
            />
          </div>

          <div class="form-group">
            <label for="editProductDescription">Description *</label>
            <textarea
              id="editProductDescription"
              name="editProductDescription"
              required
              placeholder="Enter product description"
            ></textarea>
          </div>

          <div class="form-group">
            <label for="editProductPrice">Price (₹) *</label>
            <input
              type="number"
              id="editProductPrice"
              name="editProductPrice"
              required
              placeholder="Enter product price"
              min="0"
              step="0.01"
            />
          </div>
        </form>

        <div class="modal-buttons">
          <button
            type="button"
            class="btn btn-cancel"
            onclick="closeEditModal()"
          >
            Cancel
          </button>
          <button
            type="button"
            class="btn btn-save"
            onclick="updateProduct()"
            id="updateBtn"
          >
            Update Product
          </button>
        </div>
      </div>
    </div>

    <script>
      let allProducts = [];
      let filteredProducts = [];

      // Check authentication and redirect if not seller
      function checkAuth() {
        const token = localStorage.getItem("token");
        const userType = localStorage.getItem("user_type");
        const userName = localStorage.getItem("user_name");

        if (!token || userType !== "seller") {
          alert("Access denied. Only sellers can access this dashboard.");
          window.location.href = "/login";
          return;
        }

        document.getElementById("userName").textContent = userName;
      }

      // Load products from API
      async function loadProducts() {
        try {
          const token = localStorage.getItem("token");
          if (!token) {
            throw new Error("Not authenticated");
          }
          // Fetch only the current seller's products
          const response = await fetch("/products/my", {
            headers: {
              Authorization: "Bearer " + token,
            },
          });
          if (response.ok) {
            allProducts = await response.json();
            filteredProducts = [...allProducts];
            updateStats();
            renderProducts();
          } else {
            throw new Error("Failed to load products");
          }
        } catch (error) {
          console.error("Error loading products:", error);
          document.getElementById("productsTableBody").innerHTML = `
                    <tr>
                        <td colspan="9" class="empty-state">
                            <i class="fas fa-exclamation-triangle"></i>
                            <div>Failed to load products. Please try again.</div>
                        </td>
                    </tr>
                `;
        }
      }

      // Update statistics
      function updateStats() {
        const totalProducts = allProducts.length;
        const validProducts = allProducts.filter(
          (p) => p.status === "valid"
        ).length;

        const avgRating =
          allProducts.length > 0
            ? (
                allProducts.reduce((sum, p) => sum + (p.rating || 0), 0) /
                allProducts.length
              ).toFixed(1)
            : "0.0";

        const avgAiScore =
          allProducts.length > 0
            ? Math.round(
                (allProducts.reduce(
                  (sum, p) => sum + (p.ensemble_score || 0),
                  0
                ) /
                  allProducts.length) *
                  100
              )
            : 0;

        document.getElementById("totalProducts").textContent = totalProducts;
        document.getElementById("validProducts").textContent = validProducts;
        document.getElementById("avgRating").textContent = avgRating;
        document.getElementById("avgAiScore").textContent = avgAiScore + "%";
      }

      // Render products table
      function renderProducts() {
        const tbody = document.getElementById("productsTableBody");
        const productCount = document.getElementById("productCount");

        if (filteredProducts.length === 0) {
          tbody.innerHTML = `
                    <tr>
                        <td colspan="9" class="empty-state">
                            <i class="fas fa-box-open"></i>
                            <div>No products found matching your criteria.</div>
                        </td>
                    </tr>
                `;
          productCount.textContent = "0 products found";
          return;
        }

        productCount.textContent = `${filteredProducts.length} products found`;

        tbody.innerHTML = filteredProducts
          .map((product) => {
            const aiScoreDecimal = product.ensemble_score || 0;
            const aiScorePercentage = Math.round(aiScoreDecimal * 100);
            const aiScoreClass =
              aiScorePercentage >= 80
                ? "high"
                : aiScorePercentage >= 60
                ? "medium"
                : "low";

            const productPrice = product.price || 0; // Use actual price from database
            const productImage =
              product.images && product.images.length > 0
                ? product.images[0]
                : "/assets/amazon_logo.png";

            return `
                    <tr>
                        <td>
                            <img src="${productImage}" alt="${
              product.product_name
            }" class="product-image">
                        </td>
                        <td><strong>${product.id || "N/A"}</strong></td>
                        <td>${product.product_name}</td>
                        <td>${product.description || "No description"}</td>
                        <td>₹${productPrice.toLocaleString()}</td>
                        <td>
                            <span class="ai-score ${aiScoreClass}">
                                ${aiScorePercentage}%
                            </span>
                        </td>
                        <td>
                            <div style="display: flex; align-items: center; gap: 5px;">
                                <span>${(product.rating || 0).toFixed(1)}</span>
                                <div style="color: #ffc107;">
                                    ${"★".repeat(
                                      Math.floor(product.rating || 0)
                                    )}${"☆".repeat(
              5 - Math.floor(product.rating || 0)
            )}
                                </div>
                            </div>
                        </td>
                        <td>
                            <span class="status ${product.status || "valid"}">
                                ${product.status || "valid"}
                            </span>
                        </td>
                        <td>
                            <button class="action-btn view" onclick="viewProduct('${
                              product.id
                            }')">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="action-btn edit" onclick="editProduct('${
                              product.id
                            }')">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="action-btn delete" onclick="deleteProduct('${
                              product.id
                            }')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
          })
          .join("");
      }

      // Get consistent price for a product
      function getProductPrice(product) {
        const idString = product.id
          ? product.id.toString()
          : product.product_name || "default";
        const hash = idString.split("").reduce((a, b) => {
          a = (a << 5) - a + b.charCodeAt(0);
          return a & a;
        }, 0);
        return (Math.abs(hash) % 50000) + 10000;
      }

      // Apply filters
      function applyFilters() {
        const searchTerm = document
          .getElementById("searchFilter")
          .value.toLowerCase();
        const statusFilter = document.getElementById("statusFilter").value;
        const aiScoreFilter = document.getElementById("aiScoreFilter").value;
        const sortBy = document.getElementById("sortBy").value;

        filteredProducts = allProducts.filter((product) => {
          const matchesSearch =
            product.product_name.toLowerCase().includes(searchTerm) ||
            (product.description &&
              product.description.toLowerCase().includes(searchTerm)) ||
            (product.id && product.id.toString().includes(searchTerm));

          const matchesStatus =
            !statusFilter || product.status === statusFilter;

          const aiScoreDecimal = product.ensemble_score || 0;
          const aiScorePercentage = Math.round(aiScoreDecimal * 100);
          let matchesAiScore = true;

          if (aiScoreFilter === "high")
            matchesAiScore = aiScorePercentage >= 80;
          else if (aiScoreFilter === "medium")
            matchesAiScore = aiScorePercentage >= 60 && aiScorePercentage < 80;
          else if (aiScoreFilter === "low")
            matchesAiScore = aiScorePercentage < 60;

          return matchesSearch && matchesStatus && matchesAiScore;
        });

        // Sort products
        filteredProducts.sort((a, b) => {
          switch (sortBy) {
            case "name":
              return a.product_name.localeCompare(b.product_name);
            case "ai_score":
              return (b.ensemble_score || 0) - (a.ensemble_score || 0);
            case "rating":
              return (b.rating || 0) - (a.rating || 0);
            case "price":
              return (b.price || 0) - (a.price || 0);
            case "date":
              return new Date(b.created_at || 0) - new Date(a.created_at || 0);
            default:
              return 0;
          }
        });

        renderProducts();
      }

      // Clear filters
      function clearFilters() {
        document.getElementById("searchFilter").value = "";
        document.getElementById("statusFilter").value = "";
        document.getElementById("aiScoreFilter").value = "";
        document.getElementById("sortBy").value = "name";

        filteredProducts = [...allProducts];
        renderProducts();
      }

      // Action functions
      function viewProduct(productId) {
        alert(`Viewing product ${productId}`);
        // You can implement navigation to product details page
      }

      function editProduct(productId) {
        // Find the product in the current list
        const product = allProducts.find((p) => p.id === productId);
        if (!product) {
          alert("Product not found");
          return;
        }

        // Populate the edit form
        document.getElementById("editProductId").value = productId;
        document.getElementById("editProductName").value =
          product.product_name || "";
        document.getElementById("editProductDescription").value =
          product.description || "";
        document.getElementById("editProductPrice").value = product.price || "";

        // Show the edit modal
        document.getElementById("editProductModal").style.display = "block";
      }

      async function deleteProduct(productId) {
        if (confirm(`Are you sure you want to delete this product?`)) {
          try {
            // Get token for authentication
            const token = localStorage.getItem("token");
            if (!token) {
              throw new Error("Not authenticated");
            }

            const response = await fetch(`/products/api/${productId}`, {
              method: "DELETE",
              headers: {
                Authorization: `Bearer ${token}`,
              },
            });

            if (response.ok) {
              alert("Product deleted successfully!");
              // Reload products to reflect the deletion
              loadProducts();
            } else {
              let errorMsg = "Failed to delete product";
              try {
                const error = await response.json();
                errorMsg = error.detail || errorMsg;
              } catch (e) {
                // Not JSON, use status text or raw text
                errorMsg = (await response.text()) || errorMsg;
              }
              throw new Error(errorMsg);
            }
          } catch (error) {
            console.error("Error deleting product:", error);
            alert("Failed to delete product: " + error.message);
          }
        }
      }

      function addNewProduct() {
        document.getElementById("addProductModal").style.display = "block";
      }

      // Modal functions
      function closeModal() {
        document.getElementById("addProductModal").style.display = "none";
        resetForm();
      }

      function resetForm() {
        document.getElementById("addProductForm").reset();
        document.getElementById("imagePreview").style.display = "none";
        document.getElementById("imagePreview").src = "";
      }

      // Edit modal functions
      function closeEditModal() {
        document.getElementById("editProductModal").style.display = "none";
        resetEditForm();
      }

      function resetEditForm() {
        document.getElementById("editProductForm").reset();
        document.getElementById("editProductId").value = "";
      }

      // Update product
      async function updateProduct() {
        const productId = document.getElementById("editProductId").value;
        const productName = document
          .getElementById("editProductName")
          .value.trim();
        const productDescription = document
          .getElementById("editProductDescription")
          .value.trim();
        const productPrice = parseFloat(
          document.getElementById("editProductPrice").value
        );

        // Validate form
        if (!productName) {
          alert("Please enter a product name");
          return;
        }

        if (!productDescription) {
          alert("Please enter a product description");
          return;
        }

        if (!productPrice || productPrice <= 0) {
          alert("Please enter a valid product price");
          return;
        }

        // Disable update button
        const updateBtn = document.getElementById("updateBtn");
        updateBtn.disabled = true;
        updateBtn.textContent = "Updating...";

        try {
          // Create FormData for update
          const formData = new FormData();
          formData.append("product_name", productName);
          formData.append("description", productDescription);
          formData.append("price", productPrice);

          // Get token for authentication
          const token = localStorage.getItem("token");
          if (!token) {
            throw new Error("Not authenticated");
          }

          const response = await fetch(`/products/api/${productId}`, {
            method: "PUT",
            headers: {
              Authorization: `Bearer ${token}`,
            },
            body: formData,
          });

          if (response.ok) {
            const result = await response.json();
            alert("Product updated successfully!");
            closeEditModal();

            // Reload products to show the updated one
            loadProducts();
          } else {
            let errorMsg = "Failed to update product";
            try {
              const error = await response.json();
              errorMsg = error.detail || errorMsg;
            } catch (e) {
              // Not JSON, use status text or raw text
              const textResponse = await response.text();
              errorMsg = textResponse || errorMsg;
            }
            throw new Error(errorMsg);
          }
        } catch (error) {
          console.error("Error updating product:", error);
          alert("Failed to update product: " + error.message);
        } finally {
          // Re-enable update button
          updateBtn.disabled = false;
          updateBtn.textContent = "Update Product";
        }
      }

      // Handle image upload
      function handleImageUpload(event) {
        const file = event.target.files[0];
        processImageFile(file);
      }

      // Process image file (used by both file input and drag & drop)
      function processImageFile(file) {
        if (file) {
          // Validate file size (5MB limit)
          if (file.size > 5 * 1024 * 1024) {
            alert("File size must be less than 5MB");
            return;
          }

          // Validate file type
          if (!file.type.startsWith("image/")) {
            alert("Please select an image file");
            return;
          }

          // Show preview
          const reader = new FileReader();
          reader.onload = function (e) {
            const preview = document.getElementById("imagePreview");
            preview.src = e.target.result;
            preview.style.display = "block";
          };
          reader.readAsDataURL(file);
        }
      }

      // Drag and drop functionality
      function setupDragAndDrop() {
        const dropZone = document.querySelector(".image-upload");
        const fileInput = document.getElementById("imageFile");

        dropZone.addEventListener("dragover", function (e) {
          e.preventDefault();
          dropZone.classList.add("dragover");
        });

        dropZone.addEventListener("dragleave", function (e) {
          e.preventDefault();
          dropZone.classList.remove("dragover");
        });

        dropZone.addEventListener("drop", function (e) {
          e.preventDefault();
          dropZone.classList.remove("dragover");

          const files = e.dataTransfer.files;
          if (files.length > 0) {
            const file = files[0];
            fileInput.files = files; // Set the file input
            processImageFile(file);
          }
        });
      }

      // Save product
      async function saveProduct() {
        const productName = document.getElementById("productName").value.trim();
        const productDescription = document
          .getElementById("productDescription")
          .value.trim();
        const productPrice = parseFloat(
          document.getElementById("productPrice").value
        );
        const imageFile = document.getElementById("imageFile").files[0];

        // Validate form
        if (!productName) {
          alert("Please enter a product name");
          return;
        }

        if (!productDescription) {
          alert("Please enter a product description");
          return;
        }

        if (!productPrice || productPrice <= 0) {
          alert("Please enter a valid product price");
          return;
        }

        // Disable save button
        const saveBtn = document.getElementById("saveBtn");
        saveBtn.disabled = true;
        saveBtn.textContent = "Saving...";

        try {
          // Create FormData for file upload
          const formData = new FormData();
          formData.append("product_name", productName);
          formData.append("description", productDescription);
          formData.append("price", productPrice);
          if (imageFile) {
            formData.append("image", imageFile);
          }

          // Get token for authentication
          const token = localStorage.getItem("token");
          if (!token) {
            throw new Error("Not authenticated");
          }

          const response = await fetch("/products/api/", {
            method: "POST",
            headers: {
              Authorization: `Bearer ${token}`,
            },
            body: formData,
          });

          if (response.ok) {
            const newProduct = await response.json();
            alert("Product added successfully!");
            closeModal();

            // Reload products to show the new one
            loadProducts();
          } else {
            const error = await response.json();
            throw new Error(error.detail || "Failed to add product");
          }
        } catch (error) {
          console.error("Error adding product:", error);
          alert("Failed to add product: " + error.message);
        } finally {
          // Re-enable save button
          saveBtn.disabled = false;
          saveBtn.textContent = "Save Product";
        }
      }

      // Close modal when clicking outside
      window.onclick = function (event) {
        const addModal = document.getElementById("addProductModal");
        const editModal = document.getElementById("editProductModal");
        if (event.target === addModal) {
          closeModal();
        }
        if (event.target === editModal) {
          closeEditModal();
        }
      };

      // Close modal with Escape key
      document.addEventListener("keydown", function (event) {
        if (event.key === "Escape") {
          closeModal();
          closeEditModal();
        }
      });

      // Logout function
      function logout() {
        localStorage.removeItem("token");
        localStorage.removeItem("user_type");
        localStorage.removeItem("user_id");
        localStorage.removeItem("user_name");
        window.location.href = "/register";
      }

      // Initialize dashboard
      document.addEventListener("DOMContentLoaded", () => {
        checkAuth();
        loadProducts();
        setupDragAndDrop();
      });
    </script>
  </body>
</html>
